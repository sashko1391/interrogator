<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Interrogator: AI Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Code+Pro:wght@400;500&family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#0a0a0c;--bg-secondary:#12121a;--bg-tertiary:#1a1a24;--bg-card:#15151f;--text-primary:#e8e6e3;--text-secondary:#9a9a9a;--text-muted:#5a5a6a;--accent-gold:#d4af37;--accent-gold-dim:#8b7323;--accent-red:#8b2942;--accent-green:#2d5a3d;--border-color:#2a2a3a;--border-accent:#3a3a4a;--font-display:'Playfair Display',Georgia,serif;--font-body:'Crimson Pro',Georgia,serif;--font-mono:'Source Code Pro',monospace}
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        html{font-size:22px;scroll-behavior:smooth}
        body{font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-y:auto;}
        body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");opacity:0.03;pointer-events:none;z-index:1000}
        
        .top-controls-left {position:fixed;top:1rem;left:1rem;display:flex;gap:0.5rem;z-index:50;}
        .icon-btn{background:rgba(18,18,26,0.9);border:1px solid var(--border-color);color:var(--text-muted);padding:0.4rem 0.7rem;font-family:var(--font-mono);font-size:0.6rem;cursor:pointer;border-radius:4px;min-width:32px;}
        .icon-btn.active{background:var(--accent-gold-dim);color:var(--bg-primary)}
        
        .start-screen{min-height:100vh;width:100%;display:flex;flex-direction:column;position:absolute;top:0;left:0;z-index:100;background:var(--bg-primary);}
        .start-screen.hidden{display:none}
        .start-content{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:2rem;text-align:center;}
        .start-title{font-family:var(--font-display);font-size:2.5rem;font-weight:700;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-primary);margin-bottom:0.5rem;text-shadow:0 0 60px rgba(212,175,55,0.3)}
        .start-tagline{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-muted);letter-spacing:0.3em;text-transform:uppercase;margin-bottom:2rem}
        
        /* CATEGORY CARDS */
        .category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;width:100%;max-width:900px;padding:0 1rem;}
        .cat-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:4px;padding:2rem;cursor:pointer;transition:all 0.3s;text-align:center;display:flex;flex-direction:column;align-items:center;gap:1rem;}
        .cat-card:hover{border-color:var(--accent-gold);transform:translateY(-5px);background:var(--bg-tertiary);}
        .cat-icon{font-size:3rem;margin-bottom:0.5rem;}
        .cat-title{font-family:var(--font-display);font-size:1.2rem;color:var(--accent-gold);}
        .cat-desc{font-size:0.75rem;color:var(--text-secondary);line-height:1.6;}
        
        /* LOADING SCREEN */
        .loading-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg-primary);z-index:200;align-items:center;justify-content:center;flex-direction:column;}
        .loading-screen.visible{display:flex;}
        .loader{width:50px;height:50px;border:3px solid var(--bg-tertiary);border-top:3px solid var(--accent-gold);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem;}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .loading-text{font-family:var(--font-mono);font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;animation:pulse 2s infinite;}
        @keyframes pulse{0%,100%{opacity:0.5}50%{opacity:1}}

        /* GAME SCREEN (Same as before) */
        .game-screen{display:none;min-height:100vh;width:100%;}
        .game-screen.active{display:block;}
        .game-container{max-width:900px;margin:0 auto;padding:1.5rem;min-height:100vh;display:flex;flex-direction:column;}
        .game-header{display:flex;align-items:center;gap:1.5rem;padding:1rem 0;border-bottom:1px solid var(--border-color);margin-bottom:1rem;}
        .suspect-image-container{width:100px;height:100px;border-radius:4px;overflow:hidden;border:1px solid var(--border-color);background:#000;position:relative;flex-shrink:0;}
        .suspect-image{width:100%;height:100%;object-fit:cover;}
        .game-header-text{flex:1;}
        .game-title{font-family:var(--font-display);font-size:1.2rem;text-transform:uppercase;color:var(--text-primary);}
        .game-subtitle{font-family:var(--font-mono);font-size:0.55rem;color:var(--text-muted);text-transform:uppercase;}
        
        .status-bar{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;padding:0.8rem;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:4px;margin-bottom:1rem;}
        .status-item{display:flex;flex-direction:column;gap:0.25rem}
        .status-label{font-family:var(--font-mono);font-size:0.5rem;text-transform:uppercase;letter-spacing:0.15em;color:var(--text-muted)}
        .status-value{display:flex;align-items:center;gap:0.5rem}
        .energy-display{font-family:var(--font-display);font-size:1.2rem;font-weight:700;color:var(--accent-gold)}
        
        .suspicion-container{flex:1}
        .suspicion-bar-bg{height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden}
        .suspicion-bar-fill{height:100%;width:0%;background:linear-gradient(90deg,#2d5a3d,#d4af37,#c73e5c);transition:width 300ms;border-radius:4px}
        
        .briefing-toggle{width:100%;background:var(--bg-secondary);border:1px solid var(--border-color);padding:0.8rem;color:var(--text-primary);font-family:var(--font-mono);font-size:0.65rem;text-transform:uppercase;cursor:pointer;margin-bottom:1rem;}
        .briefing-content{display:none;background:var(--bg-card);border:1px solid var(--border-color);padding:1.5rem;margin-bottom:1rem;}
        .briefing-content.visible{display:block;}
        .briefing-section-title{color:var(--accent-gold);font-family:var(--font-display);font-size:0.9rem;margin-bottom:0.5rem;}
        .briefing-text{font-size:0.75rem;color:var(--text-secondary);line-height:1.6;margin-bottom:1rem;}
        
        .chat-container{flex:1;display:flex;flex-direction:column;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:4px;overflow:hidden;height:50vh;min-height:400px;}
        .chat-log{flex-grow:1;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:1rem;}
        .message{max-width:85%;padding:1rem;border-radius:4px;}
        .message-player{align-self:flex-end;background:var(--bg-tertiary);border-right:3px solid var(--accent-gold);}
        .message-npc{align-self:flex-start;background:var(--bg-card);border-left:3px solid var(--accent-red);}
        .message-text{font-size:0.75rem;line-height:1.5;}
        
        .input-container{display:flex;gap:0.5rem;padding:1rem;background:var(--bg-tertiary);border-top:1px solid var(--border-color);}
        .chat-input{flex:1;background:var(--bg-primary);border:1px solid var(--border-color);padding:1rem;color:var(--text-primary);font-size:0.75rem;}
        .send-btn{background:var(--accent-gold-dim);border:none;padding:0 1.5rem;color:var(--bg-primary);font-family:var(--font-mono);font-size:0.6rem;font-weight:600;cursor:pointer;}
        
        .action-bar{display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap;padding-bottom:1rem;}
        .action-btn{flex:1;background:transparent;border:1px solid var(--border-color);padding:0.8rem;color:var(--text-secondary);font-family:var(--font-mono);font-size:0.6rem;text-transform:uppercase;cursor:pointer;min-width:80px;text-align:center;}
        .action-btn:hover{border-color:var(--border-accent);color:var(--text-primary);}
        .action-btn--accuse{border-color:var(--accent-red);color:var(--accent-red-bright);}
        
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:200;align-items:center;justify-content:center}
        .modal-overlay.visible{display:flex}
        .modal-content{background:var(--bg-secondary);border:1px solid var(--border-color);padding:2rem;max-width:500px;width:90%;text-align:center;}
        .modal-title{font-family:var(--font-display);font-size:1.5rem;margin-bottom:1rem;color:var(--accent-gold);}
        .modal-btn{background:var(--accent-gold-dim);border:none;padding:1rem 2rem;margin-top:1rem;cursor:pointer;font-family:var(--font-mono);font-size:0.7rem;}

        @media(max-width:600px){
            html{font-size:20px} 
            .game-container {padding: 0.5rem;}
            .game-header {flex-direction: column; align-items: center;}
            .game-header-text {text-align: center;}
            .category-grid {grid-template-columns: 1fr;}
        }
    </style>
</head>
<body>
    <div class="top-controls-left">
        <button class="icon-btn" id="mute-btn">üîä</button>
        <button class="icon-btn" id="export-btn">üíæ</button>
        <button class="icon-btn" id="back-btn">‚Üê</button>
    </div>

    <div class="start-screen" id="start-screen">
        <div class="start-content">
            <h1 class="start-title">The Interrogator</h1>
            <p class="start-tagline">AI-Generated Detective Stories</p>
            
            <div class="category-grid">
                <div class="cat-card" data-category="war">
                    <div class="cat-icon">‚öîÔ∏è</div>
                    <div class="cat-title">War Zone</div>
                    <div class="cat-desc">–£–∫—Ä–∞—ó–Ω–∞, –Ω–∞—à—ñ –¥–Ω—ñ. –®–ø–∏–≥—É–Ω–∏, –¥–∏–≤–µ—Ä—Å–∞–Ω—Ç–∏, –∑—Ä–∞–¥–Ω–∏–∫–∏. –ó–Ω–∞–π–¥–∏ –≤–æ—Ä–æ–≥–∞ —Å–µ—Ä–µ–¥ —Å–≤–æ—ó—Ö.</div>
                </div>
                <div class="cat-card" data-category="history">
                    <div class="cat-icon">üìú</div>
                    <div class="cat-title">History</div>
                    <div class="cat-desc">–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏. –ö–æ–∑–∞–∫–∏, –£–ü–ê, –ø—ñ–¥–ø—ñ–ª–ª—è. –†–æ–∑–∫—Ä–∏–π —Ç–∞—î–º–Ω–∏—Ü—ñ –º–∏–Ω—É–ª–æ–≥–æ.</div>
                </div>
                <div class="cat-card" data-category="hollywood">
                    <div class="cat-icon">üé¨</div>
                    <div class="cat-title">Hollywood 90s</div>
                    <div class="cat-desc">–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å. –í–±–∏–≤—Å—Ç–≤–∞ –Ω–∞ –∑–Ω—ñ–º–∞–ª—å–Ω–æ–º—É –º–∞–π–¥–∞–Ω—á–∏–∫—É, —Å—Ç–∞–ª–∫–µ—Ä–∏, –±—Ä—É–¥–Ω—ñ —Å–µ–∫—Ä–µ—Ç–∏ –∑—ñ—Ä–æ–∫.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-screen" id="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">–ì–µ–Ω–µ—Ä—É—é —Å–ø—Ä–∞–≤—É...<br><span style="font-size:0.6rem; opacity:0.7">(–¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ 10-15 —Å–µ–∫—É–Ω–¥)</span></div>
    </div>

    <div class="game-screen" id="game-screen">
        <div class="game-container">
            <header class="game-header">
                <div class="suspect-image-container">
                    <img id="suspect-img" class="suspect-image" src="" alt="Suspect" style="display:none;">
                </div>
                <div class="game-header-text">
                    <h1 class="game-title" id="game-title">–°–ø—Ä–∞–≤–∞ #???</h1>
                    <p class="game-subtitle" id="game-suspect-name">...</p>
                </div>
            </header>
            
            <div class="status-bar">
                <div class="status-item"><span class="status-label">Energy</span><div class="status-value"><span class="energy-display" id="energy-current">15</span></div></div>
                <div class="status-item"><span class="status-label">Pressure</span><div class="suspicion-container"><div class="suspicion-bar-bg"><div class="suspicion-bar-fill" id="suspicion-bar"></div></div><span class="suspicion-value" id="suspicion-text">0%</span></div></div>
            </div>
            
            <div class="briefing-container">
                <button class="briefing-toggle" id="briefing-toggle">üìÅ –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ —Å–ø—Ä–∞–≤–∏ ‚ñº</button>
                <div class="briefing-content" id="briefing-content">
                    <div class="briefing-section"><h3 class="briefing-section-title">–û–±—Å—Ç–∞–≤–∏–Ω–∏</h3><p class="briefing-text" id="case-description"></p></div>
                    <div class="briefing-section"><h3 class="briefing-section-title">–í—ñ–¥–æ–º—ñ —Ñ–∞–∫—Ç–∏</h3><ul class="evidence-list" id="case-evidence"></ul></div>
                    <div class="briefing-section"><h3 class="briefing-section-title">–ü—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–∏–π</h3><p class="briefing-text" id="suspect-info"></p></div>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-log" id="chat-log"></div>
                <div class="input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è...">
                    <button class="send-btn" id="send-btn">Send</button>
                </div>
            </div>
            
            <div class="action-bar">
                <button class="action-btn action-btn--hint" id="hint-btn">üí° Hint</button>
                <button class="action-btn action-btn--coffee" id="coffee-btn">‚òï Coffee</button>
                <button class="action-btn action-btn--accuse" id="accuse-btn">‚öñÔ∏è –í–µ—Ä–¥–∏–∫—Ç</button>
                <button class="action-btn action-btn--restart" id="restart-btn">‚Ü∫ Restart</button>
                <button class="action-btn action-btn--reveal" id="reveal-btn">üîì Reveal</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon" id="modal-icon">üîç</div>
            <h2 class="modal-title" id="modal-title">Case Closed</h2>
            <p class="modal-text" id="modal-text"></p>
            <div class="modal-reveal"><h4 class="modal-reveal-title">–ü—Ä–∞–≤–¥–∞</h4><p class="modal-reveal-text" id="modal-reveal-text"></p></div>
            <button class="modal-btn" id="modal-btn">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
            <a href="https://forms.gle/xtrEqNsFb8wx7uyq5" target="_blank" style="display:block; margin-top:1rem; color:#666; font-size:0.6rem; text-decoration:none;">üí¨ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</a>
        </div>
    </div>
    
    <audio id="audio-typewriter" src="p_machine.mp3" preload="auto" loop></audio>
    <audio id="audio-background" src="background.mp3" preload="auto" loop></audio>

    <script>
(function(){
'use strict';

const API_ENDPOINT='https://interrogator-api.sashko1391.workers.dev';
let currentCaseData = null; // –¢–µ–ø–µ—Ä –¥–∞–Ω—ñ —Å–ø—Ä–∞–≤–∏ –∂–∏–≤—É—Ç—å —Ç—É—Ç
let isMuted=false;
let lastVisualState = 'neutral'; 

const GameState={energy:15,maxEnergy:15,suspicion:0,hintsRemaining:3,emotionalState:'calm',conversationHistory:[],gameOver:false,
reset(){this.energy=15;this.suspicion=0;this.hintsRemaining=3;this.emotionalState='calm';this.conversationHistory=[];this.gameOver=false; lastVisualState='neutral';}};

const DOM={
    startScreen:document.getElementById('start-screen'),
    loadingScreen:document.getElementById('loading-screen'),
    gameScreen:document.getElementById('game-screen'),
    chatLog:document.getElementById('chat-log'),
    chatInput:document.getElementById('chat-input'),
    sendBtn:document.getElementById('send-btn'),
    energyCurrent:document.getElementById('energy-current'),
    suspicionBar:document.getElementById('suspicion-bar'),
    suspicionText:document.getElementById('suspicion-text'),
    briefingToggle:document.getElementById('briefing-toggle'),
    briefingContent:document.getElementById('briefing-content'),
    caseDescription:document.getElementById('case-description'),
    caseEvidence:document.getElementById('case-evidence'),
    suspectInfo:document.getElementById('suspect-info'),
    gameTitle:document.getElementById('game-title'),
    gameSuspectName:document.getElementById('game-suspect-name'),
    suspectImg:document.getElementById('suspect-img'),
    modalOverlay:document.getElementById('modal-overlay'),
    modalTitle:document.getElementById('modal-title'),
    modalText:document.getElementById('modal-text'),
    modalRevealText:document.getElementById('modal-reveal-text'),
    modalIcon:document.getElementById('modal-icon'),
    // Buttons
    catCards:document.querySelectorAll('.cat-card'),
    backBtn:document.getElementById('back-btn'),
    modalBtn:document.getElementById('modal-btn'),
    hintBtn:document.getElementById('hint-btn'),
    revealBtn:document.getElementById('reveal-btn'),
    accuseBtn:document.getElementById('accuse-btn'),
    restartBtn:document.getElementById('restart-btn'),
    coffeeBtn:document.getElementById('coffee-btn'),
    muteBtn:document.getElementById('mute-btn'),
    exportBtn:document.getElementById('export-btn'),
    audioBg:document.getElementById('audio-background'),
    audioType:document.getElementById('audio-typewriter')
};

// --- CORE GENERATION LOGIC ---
async function generateCase(category) {
    DOM.startScreen.classList.add('hidden');
    DOM.loadingScreen.classList.add('visible');
    
    try {
        const r = await fetch(API_ENDPOINT + '/generate', {
            method: 'POST',
            body: JSON.stringify({ category: category })
        });
        
        if (!r.ok) throw new Error("API Error");
        
        const data = await r.json();
        currentCaseData = data;
        
        startGame();
        
    } catch (e) {
        console.error(e);
        alert("–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –∞–±–æ API.");
        DOM.loadingScreen.classList.remove('visible');
        DOM.startScreen.classList.remove('hidden');
    }
}

function startGame() {
    DOM.loadingScreen.classList.remove('visible');
    DOM.gameScreen.classList.add('active');
    
    GameState.reset();
    updateUI();
    
    // Fill Data
    DOM.gameTitle.textContent = currentCaseData.title;
    DOM.gameSuspectName.textContent = currentCaseData.suspectName;
    DOM.caseDescription.textContent = currentCaseData.crimeDescription;
    DOM.suspectInfo.textContent = currentCaseData.suspectProfile;
    
    DOM.caseEvidence.innerHTML = currentCaseData.knownFacts.map(f => `<li>${f}</li>`).join('');
    
    DOM.chatLog.innerHTML = '';
    DOM.suspectImg.src = "https://placehold.co/400x400/1a1a24/d4af37?text=?"; // Fallback placeholder
    
    // Start Audio
    if(!isMuted) DOM.audioBg.play().catch(e=>{});
    
    addMsg("–î–æ–ø–∏—Ç —Ä–æ–∑–ø–æ—á–∞—Ç–æ.", 'system');
    
    // Initial Image Gen
    generateSuspectImage();
    
    // NPC Greeting
    setTimeout(() => {
        GameState.conversationHistory.push({role:'assistant', content: currentCaseData.npcGreeting});
        addMsg(currentCaseData.npcGreeting, 'npc');
    }, 500);
    
    DOM.briefingToggle.classList.add('active');
    DOM.briefingContent.classList.add('visible');
}

// --- IMAGE GEN ---
async function generateSuspectImage() {
    // Logic: Only gen on major emotional shifts
    let newState = 'calm';
    if (GameState.suspicion > 80) newState = 'broken';
    else if (GameState.suspicion > 50) newState = 'nervous';
    
    if (newState === lastVisualState && DOM.suspectImg.src.includes('replicate')) return;
    lastVisualState = newState;
    
    let prompt = currentCaseData.visualPrompt;
    if(newState === 'nervous') prompt += ", nervous, sweating, anxious eyes";
    if(newState === 'broken') prompt += ", crying, looking down, defeated, despair";
    
    try {
        const r = await fetch(API_ENDPOINT + '/image', {
            method: 'POST',
            body: JSON.stringify({ prompt: prompt })
        });
        const data = await r.json();
        if(data.imageUrl) DOM.suspectImg.src = data.imageUrl;
    } catch(e) {
        console.log("Image gen skip/fail");
    }
}

// --- CHAT LOGIC ---
async function sendMessage() {
    if(GameState.gameOver || GameState.energy <= 0) return;
    
    const txt = DOM.chatInput.value.trim();
    if(!txt) return;
    
    DOM.chatInput.value = '';
    GameState.energy--;
    updateUI();
    
    addMsg(txt, 'player');
    GameState.conversationHistory.push({role:'user', content: txt});
    
    // UI Updates
    showTyping();
    
    // Prepare Prompt with Dynamic Pressure
    const sysPrompt = `${currentCaseData.systemPrompt}\n\nCURRENT STATE:\nSuspicion Level: ${GameState.suspicion}%\nEnergy Left: ${GameState.energy}\n\nINSTRUCTIONS: Respond to the detective. If they catch you in a lie or press hard, increase your nervousness. ALWAYS append hidden tag <<<NERVOUSNESS: [0-100]>>> at the end.`;
    
    try {
        const r = await fetch(API_ENDPOINT + '/chat', {
            method: 'POST',
            body: JSON.stringify({
                system: sysPrompt,
                messages: GameState.conversationHistory
            })
        });
        
        const data = await r.json();
        let reply = data.content[0].text;
        
        // Parse Nervousness
        const match = reply.match(/<<<NERVOUSNESS:\s*(\d+)>>>/);
        if(match) {
            GameState.suspicion = parseInt(match[1]);
            reply = reply.replace(match[0], '').trim();
            updateUI();
            generateSuspectImage();
        }
        
        GameState.conversationHistory.push({role:'assistant', content: reply});
        hideTyping();
        addMsg(reply, 'npc');
        
    } catch(e) {
        hideTyping();
        addMsg("*–º–æ–≤—á–∏—Ç—å*", 'npc');
    }
    
    if(GameState.energy <= 0) setTimeout(()=>showModal('lose', "–ï–Ω–µ—Ä–≥—ñ—è –≤–∏—á–µ—Ä–ø–∞–Ω–∞. –î–æ–ø–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ."), 1000);
}

// --- VERDICT LOGIC (AI JUDGE) ---
async function handleAccuse() {
    if(GameState.gameOver) return;
    
    const choice = prompt("–í–∞—à –≤–µ—Ä–¥–∏–∫—Ç:\n1. –í–∏–Ω–µ–Ω (–ü–æ–≤–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è)\n2. –ù–µ–≤–∏–Ω—É–≤–∞—Ç–∏–π / –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–æ–∫–∞–∑—ñ–≤\n\n–í–≤–µ–¥—ñ—Ç—å 1 –∞–±–æ 2:");
    if(choice !== '1') {
        showModal('lose', "–í–∏ –≤—ñ–¥–ø—É—Å—Ç–∏–ª–∏ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ –∞–±–æ –Ω–µ –Ω–∞–≤–∞–∂–∏–ª–∏—Å—è –Ω–∞ –∑–≤–∏–Ω—É–≤–∞—á–µ–Ω–Ω—è.");
        return;
    }
    
    addMsg("‚è≥ *–ê–Ω–∞–ª—ñ–∑ –≤–µ—Ä–¥–∏–∫—Ç—É...*", 'system');
    
    // Judge Prompt
    const log = GameState.conversationHistory.map(m => `${m.role}: ${m.content}`).join('\n');
    const judgePrompt = `
    Case: ${currentCaseData.title}
    Truth: ${currentCaseData.truthReveal}
    
    Analyze the interrogation log below. Did the user uncover the truth or break the suspect?
    Reply JSON ONLY: { "verdict": "WIN" or "LOSE", "reason": "Reason in Ukrainian" }
    
    LOG:
    ${log}
    `;
    
    try {
        const r = await fetch(API_ENDPOINT + '/chat', {
            method: 'POST',
            body: JSON.stringify({
                system: "You are a Senior Detective Judge.",
                messages: [{role:'user', content: judgePrompt}]
            })
        });
        const data = await r.json();
        const res = JSON.parse(data.content[0].text.replace(/```json/g,'').replace(/```/g,''));
        
        showModal(res.verdict.toLowerCase(), res.reason);
        
    } catch(e) {
        // Fallback
        GameState.suspicion > 60 ? showModal('win', "–ó–∞ —Å—É–∫—É–ø–Ω—ñ—Å—Ç—é –¥–æ–∫–∞–∑—ñ–≤.") : showModal('lose', "–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–∏—Å–∫—É.");
    }
}

// --- UTILS ---
function updateUI() {
    DOM.energyCurrent.textContent = GameState.energy;
    DOM.suspicionBar.style.width = GameState.suspicion + '%';
    DOM.suspicionText.textContent = GameState.suspicion + '%';
    DOM.coffeeBtn.disabled = GameState.energy >= 15;
}

function addMsg(text, type) {
    const d = document.createElement('div');
    d.className = `message message-${type}`;
    d.innerHTML = `<div class="message-sender">${type==='player'?'–°–ª—ñ–¥—á–∏–π':'–ü—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–∏–π'}</div><div class="message-text">${text}</div>`;
    DOM.chatLog.appendChild(d);
    DOM.chatLog.scrollTop = DOM.chatLog.scrollHeight;
    
    if(type==='npc' && !isMuted) {
        DOM.audioType.currentTime=0; DOM.audioType.play().catch(()=>{});
    }
}

function showTyping(){
    const d=document.createElement('div'); d.id='typing'; d.className='typing-indicator';
    d.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    DOM.chatLog.appendChild(d); DOM.chatLog.scrollTop=DOM.chatLog.scrollHeight;
}
function hideTyping(){ document.getElementById('typing')?.remove(); }

function showModal(type, text) {
    GameState.gameOver = true;
    DOM.modalOverlay.classList.add('visible');
    DOM.modalIcon.textContent = type==='win' ? '‚úÖ' : '‚ùå';
    DOM.modalTitle.textContent = type==='win' ? '–°–ø—Ä–∞–≤—É —Ä–æ–∑–∫—Ä–∏—Ç–æ' : '–ü—Ä–æ–≤–∞–ª';
    DOM.modalText.textContent = text;
    DOM.modalRevealText.textContent = currentCaseData.truthReveal;
}

// --- EVENTS ---
DOM.catCards.forEach(c => c.addEventListener('click', () => generateCase(c.dataset.category)));
DOM.sendBtn.addEventListener('click', sendMessage);
DOM.chatInput.addEventListener('keypress', e => { if(e.key==='Enter') sendMessage() });
DOM.briefingToggle.addEventListener('click', () => DOM.briefingContent.classList.toggle('visible'));
DOM.hintBtn.addEventListener('click', () => { 
    if(GameState.hintsRemaining > 0) {
        GameState.hintsRemaining--;
        // –¢—É—Ç –º–æ–∂–Ω–∞ –±—Ä–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫–∏ –∑ currentCaseData.knownFacts —è–∫—â–æ –≤–æ–Ω–∏ —î, –∞–±–æ –ø—Ä–æ—Å—Ç–æ –≥–µ–Ω–µ—Ä–∏—Ç–∏
        addMsg("üí° –ó–≤–µ—Ä–Ω–∏ —É–≤–∞–≥—É –Ω–∞ –¥—Ä—ñ–±–Ω—ñ –¥–µ—Ç–∞–ª—ñ –≤ –π–æ–≥–æ —ñ—Å—Ç–æ—Ä—ñ—ó.", 'system');
    }
});
DOM.coffeeBtn.addEventListener('click', () => { if(GameState.energy<15){GameState.energy=Math.min(15, GameState.energy+5); updateUI(); addMsg("*–≤–∏–ø–∏–≤ –∫–∞–≤–∏*", 'system')} });
DOM.accuseBtn.addEventListener('click', handleAccuse);
DOM.revealBtn.addEventListener('click', () => { if(confirm("–ó–¥–∞—Ç–∏—Å—è?")) showModal('lose', "–í–∏ –∑–¥–∞–ª–∏—Å—è."); });
DOM.restartBtn.addEventListener('click', () => startGame()); // Restart same case
DOM.backBtn.addEventListener('click', () => { DOM.gameScreen.classList.remove('active'); DOM.startScreen.classList.remove('hidden'); });
DOM.modalBtn.addEventListener('click', () => { DOM.modalOverlay.classList.remove('visible'); DOM.gameScreen.classList.remove('active'); DOM.startScreen.classList.remove('hidden'); });
DOM.muteBtn.addEventListener('click', () => { isMuted=!isMuted; DOM.muteBtn.textContent=isMuted?'üîá':'üîä'; if(isMuted) DOM.audioBg.pause(); else DOM.audioBg.play(); });
DOM.exportBtn.addEventListener('click', exportChat);

})();
</script>
</body>
</html>
